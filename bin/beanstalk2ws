#!/usr/bin/env ruby

require 'json'
require 'em-websocket'
require 'em-jack'
require 'logger'

# plugin must be loaded first!
require 'sequel'
Sequel::Model.plugin :json_serializer
require_relative '../model/init'
require_relative '../options'

TCC::Log.level = Log4r.const_get(TCC.options.log_level)

module TCC
  class RibbonWebSocket < EM::WebSocket::Connection
    def self.start(options, &block)
      EM.epoll?

      EM.run do
        EM.start_server(options[:host], options[:port], self, options, &block)
      end
    end

    def trigger_on_message(message)
      Log.debug "Message: %p" % {message: message}
      raw = JSON.parse(message)
      frame, body = raw.values_at('frame', 'body')
      url, method, id, attr =
        body.values_at('url', 'method', 'id', 'attributes')

      bbm = "backbone_#{method}"
      if url == 'Agent'
        say frame: frame, ok: __send__(bbm, id, attr)
      else
        raise 'Unknown url %p in %p' % [url, raw]
      end

    rescue => ex
      Log.error(ex)
      say frame: frame, error: ex.to_s
    end

    def say(obj)
      Log.debug say: obj
      send(obj.to_json)
    end

    EXPOSE = [
      :id, :first_name, :last_name, :registration_server,
      :username, :extension
    ]

    def backbone_read(id, attributes)
      Log.debug read: {id: id, attributes: attributes}

      if id
        account = Account[id: id]
      else
        ext = attributes['extension']
        account = Account[extension: ext]
        agent_connected(account)
      end

      raise 'no account found' unless account
      JSON.parse(account.to_json(only: EXPOSE))
    end

    def agent_connected(account)
      FSR.load_all_commands
      fsr = FSR::CommandSocket.new(server: TCC.options.command_server)
      cmd = fsr.call_center(:agent).set(account.agent, :status, 'Available')
      Log.debug cmd.raw
      Log.debug cmd.run
    end

    def backbone_create(*args)
      Log.debug create: args
    end

    def backbone_update(*args)
      Log.debug update: args
    end

    def backbone_delete(*args)
      Log.debug delete: args
    end
  end
end

EM.run do
  # use the faster one, we don't care about the binary part
  host = '0.0.0.0'
  port = 43443
  TCC::Log.info "Starting Websocket on #{host}:#{port}"
  TCC::RibbonWebSocket.start(host: host, port: port, debug: false)

  jack = EMJack::Connection.new

  tube = jack.watch('pg')
  tube.callback{|t|
    TCC::Log.debug "Jack is listening on #{t}"

    jack.each_job do |job|
      TCC::Log.debug job
    end
  }
end
